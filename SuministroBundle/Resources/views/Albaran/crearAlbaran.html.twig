{% extends 'RGMELibreriaIndexBundle::layout.html.twig' %}

{% block contenido %}
<div id="marco">
	<div id="cuerpo_marco">
		{% if salida %}<header>{{ salida }}</header>{% endif %}
		<div class="form_s">
			<form method="POST" action="{{ ruta_form }}">
				{{ form_widget(form) }}
				<input type="submit" value="Enviar">
			</form>
		</div>
	</div>
</div>

<script>
$('form').bind("keydown keyup", function(e) {
	  var code = e.keyCode || e.which; 
	  if (code  == 13) {               
	    e.preventDefault();
	    return false;
	  }
	});

$('input').each( function(){
	$elemento=$(this);
	
	$elemento.focus(function(e){
		$e=$(e.target);
		if($.inArray($e.val(), ['ISBN', 'Titulo', 'Editorial', 'Unid.', 'Precio', 'IVA', 'Desc']) > -1){
			$e.val("");
		}
	});
});
	
function recargarAjax(){
	$('input').each( function(){
		$elemento=$(this);
		
		$elemento.focus(function(e){
			$e=$(e.target);
			if($.inArray($e.val(), ['ISBN', 'Titulo', 'Editorial', 'Unid.', 'Precio', 'IVA', 'Desc']) > -1){
				$e.val("");
			}
		});
	});
	
	$('.refAjax').each(function (){
		$elemento=$(this);

		if(! $elemento.is('.ui-autocomplete-input')){
			a = $elemento.autocomplete({
			      source: function( request, response ) {
				      $.ajax({
			            url: "{{ path('rgm_e_libreria_suministrobundle_albaran_buscar_referencia_ajax') }}",
			            data: {
			              isbn: request.term,
			              maxRows: 12
			            },
			            success: function( data ) {
	
				          $data = jQuery.parseJSON(data);
			            	
			              response( $.map( $data.sugerencias, function(item){
				          		return {
					          		label: item.isbn + " - " + item.titulo + (item.editorial ? " [ " + item.editorial + " ]" : ""),
					          		value: item.isbn,
					          		isbn: item.isbn,
					          		titulo: item.titulo,
					          		editorial: item.editorial
					          	};    
				          }));
			            }
			          });
			        },
	
		        select: function( event, ui ) {

					id=event.target.id;
			        
			        $abuelo = $('#'+id).parent().parent();
			        
		            $abuelo.find('.titulo').val(ui.item.titulo);
		            $abuelo.find('.editorial').val(ui.item.editorial);
		          }
			 });
		}
	});
};


	
// Get the ul that holds the collection of tags
	var collectionHolder = $('div#rgm_e_libreria_suministrobundle_crearalbarantype_lineas');
	
	// setup an "add a tag" link
	var $addTagLink = $('<a title="Añadir Nueva entrada" class="add_new" href="#" class="add_tag_link">Añadir un elemento</a>');
	var $newLinkLi = $('<div class="add_div"></div>').append($addTagLink);
	
	function crearBoton(){
	    // add the "add a tag" anchor and li to the tags ul
	    collectionHolder.prepend($newLinkLi);
	    
	    collectionHolder.children().not(":first-child").each(function() {
	        addTagFormDeleteLink($(this));
	    });

	    // count the current form inputs we have (e.g. 2), use that as the new
	    // index when inserting a new item (e.g. 2)
	    collectionHolder.data('index', collectionHolder.find(':input').length);

	    $addTagLink.on('click', function(e) {
	        // prevent the link from creating a "#" on the URL
	        e.preventDefault();

	        // add a new tag form (see next code block)
	        addTagForm(collectionHolder, $newLinkLi);
	    });
	}	

	jQuery(document).ready(crearBoton);
	
	function addTagForm(collectionHolder, $newLinkLi) {
	    // Get the data-prototype explained earlier
	    var prototype = collectionHolder.data('prototype');
	    var msg_confirmar = $('p#msg_confirmar');
	    msg_confirmar.remove();

	    // get the new index
	    var index = collectionHolder.data('index');

	    // Replace '$$name$$' in the prototype's HTML to
	    // instead be a number based on how many items we have
	    var newForm = prototype.replace(/__name__/g, index);
	    newForm = newForm.replace(/label__/g, '');

	    // increase the index with one for the next item
	    collectionHolder.data('index', index + 1);

	    // Display the form in the page in an li, before the "Add a tag" link li
	    var $newFormLi = $(newForm);

	    addTagFormDeleteLink($newFormLi);
	    
	    collectionHolder.append($newFormLi);
	    
	    $('.dateJquery').datepicker({ dateFormat: 'dd-mm-yy' });
	    recargarAjax();
	}

	
	function addTagFormDeleteLink($tagFormLi) {
	    var $removeFormA = $('<a title="Borrar Elemento" class="delete_element" href="#">Borrar este elemento</a>');
		    
	    $tagFormLi.prepend($removeFormA);

	    $removeFormA.on('click', function(e) {
	        // prevent the link from creating a "#" on the URL
	        e.preventDefault();

	        // remove the li for the tag form
	        $tagFormLi.remove();
	        $removeFormA.remove();
	    });
	}
</script>
{% endblock %}